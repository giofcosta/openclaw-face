name: Auto-move Project Cards

# This workflow moves project cards when PRs are opened or merged.
# Requires a Personal Access Token (PAT) with 'project' and 'repo' scopes
# stored as repository secret named PROJECT_TOKEN.

on:
  pull_request:
    types: [opened, closed]

env:
  PROJECT_ID: "PVT_kwHOADjgZc4BOBZN"
  STATUS_FIELD_ID: "PVTSSF_lAHOADjgZc4BOBZNzg82Huw"
  # Status option IDs
  TODO_OPTION: "f75ad846"
  IN_PROGRESS_OPTION: "47fc9ee4"
  PR_OPENED_OPTION: "a70450ff"
  IN_REVIEW_OPTION: "d5680462"
  DONE_OPTION: "98236657"

jobs:
  move-card:
    runs-on: ubuntu-latest
    steps:
      - name: Debug
        run: |
          echo "Event: ${{ github.event.action }}"
          echo "Merged: ${{ github.event.pull_request.merged }}"
          echo "PR Body: ${{ github.event.pull_request.body }}"

      - name: Move to PR opened
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            console.log('=== Move to PR opened ===');
            
            const body = context.payload.pull_request.body || '';
            const match = body.match(/(?:closes?|fixes?|resolves?)\s*#(\d+)/i);
            
            if (!match) {
              console.log('No linked issue found in PR body');
              return;
            }
            
            const issueNumber = parseInt(match[1]);
            console.log(`Found linked issue: #${issueNumber}`);
            
            try {
              // Query project items directly to find the issue
              const projectQuery = `
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              number
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const projectResult = await github.graphql(projectQuery, {
                projectId: process.env.PROJECT_ID
              });
              
              const items = projectResult.node.items.nodes;
              const projectItem = items.find(item => 
                item.content && item.content.number === issueNumber
              );
              
              if (!projectItem) {
                console.log(`Issue #${issueNumber} not found in project`);
                return;
              }
              
              console.log('Found project item:', projectItem.id);
              
              // Move the card to "PR opened"
              const moveResult = await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { singleSelectOptionId: $optionId }
                    }
                  ) {
                    projectV2Item { 
                      id
                    }
                  }
                }
              `, {
                projectId: process.env.PROJECT_ID,
                itemId: projectItem.id,
                fieldId: process.env.STATUS_FIELD_ID,
                optionId: process.env.PR_OPENED_OPTION
              });
              
              console.log(`Successfully moved issue #${issueNumber} to "PR opened"`);
              
            } catch (error) {
              console.error('Error moving card:', error.message);
              console.error('Full error:', error);
            }

      - name: Move to Done
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            console.log('=== Move to Done ===');
            console.log('PR merged:', context.payload.pull_request.merged);
            
            const body = context.payload.pull_request.body || '';
            const match = body.match(/(?:closes?|fixes?|resolves?)\s*#(\d+)/i);
            
            if (!match) {
              console.log('No linked issue found in PR body');
              return;
            }
            
            const issueNumber = parseInt(match[1]);
            console.log(`Found linked issue: #${issueNumber}`);
            
            try {
              // Query project items directly to find the issue
              const projectQuery = `
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              number
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const projectResult = await github.graphql(projectQuery, {
                projectId: process.env.PROJECT_ID
              });
              
              const items = projectResult.node.items.nodes;
              const projectItem = items.find(item => 
                item.content && item.content.number === issueNumber
              );
              
              if (!projectItem) {
                console.log(`Issue #${issueNumber} not found in project`);
                return;
              }
              
              console.log('Found project item:', projectItem.id);
              
              // Move the card to "Done"
              const moveResult = await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { singleSelectOptionId: $optionId }
                    }
                  ) {
                    projectV2Item { 
                      id
                    }
                  }
                }
              `, {
                projectId: process.env.PROJECT_ID,
                itemId: projectItem.id,
                fieldId: process.env.STATUS_FIELD_ID,
                optionId: process.env.DONE_OPTION
              });
              
              console.log(`Successfully moved issue #${issueNumber} to "Done"`);
              
            } catch (error) {
              console.error('Error moving card:', error.message);
              console.error('Full error:', error);
            }
